{{outlet}}
{{#if this.addLiteral.isRunning}}
  <div class="task-running">
    <div class="uk-position-center uk-text-large">
      Adding Tag from Match
    </div>
  </div>
{{/if}}
{{#if this.saveSuggestion.isRunning}}
  <div class="task-running">
    <div class="uk-position-center uk-text-large">
      Saving Suggestion
    </div>
  </div>
{{/if}}
{{#if this.updateLetter.isRunning}}
  <div class="task-running">
    <div class="uk-position-center uk-text-large">
      Updating Letter
    </div>
  </div>
{{/if}}
{{#if this.flagEntity.isRunning}}
  <div class="task-running">
    <div class="uk-position-center uk-text-large">
      Flagging Text
    </div>
  </div>
{{/if}}
{{#if this.unTagEntity.isRunning}}
  <div class="task-running">
    <div class="uk-position-center uk-text-large">
      Clearing Selection
    </div>
  </div>
{{/if}}
{{#if this.editTag.isRunning}}
  <div class="task-running">
    <div class="uk-position-center uk-text-large">
      Fetching Tag Information
    </div>
  </div>
{{/if}}
{{#if this.search.isRunning}}
  <div class="task-running">
    <div class="uk-position-center uk-text-large">
      Searching
    </div>
  </div>
{{/if}}

<h1>{{model.letter.formatted_date}} - {{model.letter.recipient_list}}</h1>

<div class="uk-child-width-1-2" uk-grid>
  {{#if model.letter.content}}
    <section class="">
      {{!-- If text selected --}}
      {{#if selectedText}}
        <section class="uk-form-stacked">
          {{#if (not this.tagToEdit)}}
            <legend class="uk-legend uk-margin">Tag Entity</legend>
            <section>
              Selected Text:
              <strong>
                {{this.selectedText}}
              </strong>
            </section>
            <section class="uk-margin-small">
              <UkButton @on-click={{action "reset"}} @color="primary">
                Deselect
              </UkButton>
            </section>
            {{!-- Select Type --}}
            {{!-- {{#if model.entityTypes}} --}}

            <section class="uk-margin">
              <label class="uk-form-label uk-text-large" for="select-type">
                Type
              </label>
              <section class="uk-form-controls">
                <select id="select-type" class="uk-select" onchange={{action "setType"}}>
                  <option value="" selected>
                    Select Type
                  </option>
                  {{#each model.entityTypes as |type|}}
                    <option value={{type.id}} selected={{or
                      (eq entityType type.label)
                      (eq selectedType.label type.label)
                      }}>
                      {{type.pretty_label}}
                    </option>
                  {{/each}}
                </select>
              </section>
            </section>
          {{/if}}
          {{!-- If entity selected --}}

          {{!--  Type Selected  --}}
          {{#if (and (and (and this.selectedType (not this.entitySelected)) (not this.newEntity)) (not this.tagToEdit))}}

            <form {{action "searchOnEnter" on="submit"}} class="uk-margin">
              <label class="uk-form-label uk-text-large" for="entity-search">
                Search
              </label>
              <section class="uk-form-controls" uk-grid>
                <section class="uk-width-2-3">
                  <section class="uk-search uk-search-default">
                    <span uk-search-icon></span>
                    {{input class="uk-search-input" id="entity-search" type="search" value=this.queryText onkeydown=(action (mut this.queryText) (action "searchOnEnter") value="target.value")}}
                  </section>
                </section>
                <section class="uk-width-1-3">
                  <UkButton @color="primary" @on-click={{perform this.search}}>
                    Search
                  </UkButton>
                </section>
              </section>
            </form>


            {{!-- {{#if (is-empty entityToEdit.id)}} --}}
            <section>
              <UkButton @on-click={{perform flagEntity}} @color="primary">
                Not Sure
              </UkButton>
              <UkButton @on-click={{perform suggestNewEntity}} @color="secondary">
                Suggest New
                {{selectedType.label}}
              </UkButton>
            </section>
            <section class="uk-margin">
              <SearchResults @results={{this.results}}
                @addExistingEntity={{this.tagExistingEntity}}></SearchResults>
            </section>
          {{else if this.tagToEdit}}
            {{#if this.tagToEdit.flagged}}
              <fieldset class="uk-fieldset">
                <legend class="uk-legend">
                  Label
                </legend>
                <div class="uk-margin">
                  {{pell-editor
                    class="pell"
                    value=this.tagToEdit.label
                    pellOptions=editorOptions
                    onChange=(action (mut this.tagToEdit.label))
                  }}
                </div>
                <legend class="uk-legend">
                  Description
                </legend>
                <div class="uk-margin">
                  {{pell-editor
                    class="pell"
                    value=tagToEdit.properties.description
                    pellOptions=editorOptions
                    onChange=(action (mut tagToEdit.properties.description))
                  }}
                </div>
                <div class="uk-margin">
                  <UkButton @color="primary" @on-click={{perform unFlag tagToEdit}}>
                    Approve
                  </UkButton>
                </div>
              </fieldset>
            {{else}}
              <table class="uk-table">
                <tbody>
                  <tr>
                    <td class="uk-table-shrink uk-text-bold">Label</td>
                    <td class="uk-table-expand">{{{tagToEdit.label}}} {{if (eq tagToEdit.type_label 'Person') (concat '(' tagToEdit.properties.life-dates ')')}}</td>
                  </tr>
                  <tr>
                    <td class="uk-table-shrink uk-text-bold">Type</td>
                    <td class="uk-table-expand">{{tagToEdit.type_label}}</td>
                  </tr>
                  <tr>
                    <td class="uk-table-shrink uk-text-bold">Description</td>
                    <td class="uk-table-expand">{{tagToEdit.properties.description}}</td>
                  </tr>
                </tbody>
              </table>
            {{/if}}
            <section class="uk-form-controls">
              <UkButton @color="secondary" @on-click={{action "removeTag"}}>
                Remove Tag
              </UkButton>
              <UkButton @color="link" @on-click={{action "reset"}}>
                Cancel
              </UkButton>
            </section>
          {{else if newEntity}}
            <fieldset class="uk-fieldset">
              <legend class="uk-legend">Label</legend>
              <div class="uk-margin">
                {{pell-editor
                  class="pell"
                  value=newEntity.label
                  pellOptions=editorOptions
                  onChange=(action (mut newEntity.label))
                }}
              </div>

              <legend class="uk-legend">Description</legend>
              <div class="uk-margin">
                {{pell-editor
                  class="pell"
                  value=newEntity.properties.description
                  pellOptions=editorOptions
                  onChange=(action (mut newEntity.properties.description))
                }}
              </div>

              <div class="uk-margin">
                <UkButton @color="primary" @on-click={{perform saveSuggestion}}>
                  Save
                </UkButton>
              </div>
              
            </fieldset>
          {{else}}
          {{/if}}
        </section>
      {{else}}
        <h1 class="uk-heading-hero uk-text-muted uk-text-uppercase uk-text-center">
          Select text to tag
        </h1>
        <h2>Tagged in this Letter</h2>
        {{!-- <section>{{model.letter.entities_mentioned_list}}</section> --}}
        <dl class="uk-description-list uk-description-list-divider">
          {{#each model.letter.entities_mentioned as |entity|}}
            <dt class={{if entity.flagged "flagged"}}>
              {{{if entity.label entity.label "Loading...."}}} {{if (eq entity.type_label 'Person') (concat '(' entity.properties.life-dates ')')}}
            </dt>
            <dd class={{if entity.flagged "flagged"}}>
              {{{entity.properties.description}}}
            </dd>
          {{/each}}
        </dl>
      {{/if}}
    </section>
    <LetterWrapper @entityTypes={{model.entityTypes}}>
      <div class="uk-panel uk-panel-scrollable letter-container
          {{if selectedText "no-select"}}">
        <LettersView @letter={{model.letter}} @select={{action "setSelected"}}
          @editTag={{perform editTag}} @contenteditable={{this.editLetter}}>
        </LettersView>
      </div>
      {{#if this.editLetter}}
        <UkButton @color="primary" @on-click={{perform this.updateLetter}}>Save Letter</UkButton>
      {{else}}
        <UkButton @color="secondary" @on-click={{action (toggle "editLetter" this)}}>Edit Letter</UkButton>
      {{/if}}
    </LetterWrapper>
  {{else}}
    <div class="uk-width-1-1">
      <LetterInput @setLetter={{action "setLetter"}} @letterContent={{letterContent}} class="letter-container" />

    </div>
  {{/if}}
</div>